/*
 * Parchment Z-Machine UI and Runner
 * Built: 2011-05-15
 *
 * Copyright (c) 2008-2010 The Parchment Contributors
 * Licenced under the GPL v2
 * http://code.google.com/p/parchment
 */
(function(c){var b=/ /g,a=/(\S) (\S)/g,d=/<&>/g;parchment.lib.ZUI=Object.subClass({init:function(g,h,i){var f=this,e=(gIsIphone&&c(document.body).width()<=480)?38:parchment.options.width;g.container.html('<div id="top-window" class="buffered-window"></div><div id="buffered-windows"></div><div id="content" role="log"></div><div id="bottom"></div>');c.extend(f,{_size:[e,25],_console:null,_activeWindow:0,_currentCallback:null,_foreground:"default",_background:"default",_reverseVideo:false,_lastSeenY:0,_currStyles:["z-roman"],_expectedHash:window.location.hash,_isFixedWidth:false,_bufferMode:0,library:g,engine:h,hidden_load_indicator:0,bottom:c("#bottom"),current_input:c("#current-input"),text_input:new parchment.lib.TextInput("#parchment","#content","#top-window"),_log:i||c.noop,_windowHashCheck:function(){if(window.location.hash!=f._expectedHash){f._restart()}}});f._setFixedPitchSizes();c("#top-window").css({width:f._pixelWidth+"px",lineHeight:f._pixelLineHeight+"px"});c("#content").css({width:f._pixelWidth+"px"});f._windowResize();f._bindEventHandlers();f._eraseBottomWindow()},onConsoleRender:function(){var e=c("#top-window").height();c("#content").css({padding:""+e+"px 0 0 0"})},_finalize:function(){var e=this;if(e._console){e._console.close();e._console=null}e.onPrint("\n[ The game has finished. ]");e._unbindEventHandlers()},_bindEventHandlers:function(){var e=this;c(window).resize(e._windowResize);e._intervalId=window.setInterval(e._windowHashCheck,1000)},_unbindEventHandlers:function(){var e=this;c(window).unbind("resize",e._windowResize);window.clearInterval(e._intervalId);this.text_input.die()},_windowResize:function(){var e=c("#content").offset().left+"px";c(".buffered-window").css({left:e})},_removeBufferedWindows:function(){var e=c("#buffered-windows > .buffered-window");e.fadeOut("slow",function(){e.remove()});if(!this.hidden_load_indicator){this.hidden_load_indicator=1;this.library.load_indicator.detach()}},_eraseBottomWindow:function(){c("#content").empty();this._lastSeenY=0},_restart:function(){this._finalize();location.reload()},setVersion:function(e){this._version=e},getSize:function(){return this._size},onLineInput:function(h){var e=this;if(e.engine.m_version<=3){var f=e._activeWindow;var g=e._reverseVideo;if(!e._console){e.onSplitWindow(1)}e._console.moveTo(0,0);e._activeWindow=1;e._reverseVideo=true;e.onPrint(e.engine.getStatusLine(e._console.width));e._reverseVideo=g;e._activeWindow=f}if(!e.hidden_load_indicator){e.hidden_load_indicator=1;e.library.ui.load_indicator.detach()}e._currentCallback=h;e.text_input.getLine(h,e._calcFinalStyles())},onCharacterInput:function(f){var e=this;e._currentCallback=f;if(!e.hidden_load_indicator){e.hidden_load_indicator=1;e.library.ui.load_indicator.detach()}e.text_input.getChar(f)},onSave:function(h){var e=this,g=this.library.url+"_saveData",f=file.base64_encode(h);if(window.globalStorage&&location.href.slice(0,5)!="file:"){window.globalStorage[location.hostname][g]=f}location=location.protocol+"//"+location.host+location.pathname+location.search+"#"+f;e._expectedHash=location.hash;e.onPrint("Your game has been saved to the URL. You may want to bookmark this page now; just reload it at any time to restore your game from this point.\n");return true},onRestore:function(){var f=null;if(location.hash){f=location.hash.slice(1)}if(!f&&window.globalStorage){var e=globalStorage[location.hostname][this.library.url+"_saveData"];if(e){f=e.value;location=location.protocol+"//"+location.host+location.pathname+location.search+"#"+f;this._expectedHash=location.hash}}if(f){return file.base64_decode(f)}else{return null}},onQuit:function(){this._finalize()},onRestart:function(){var e=this;e._finalize();window.location.hash="";e._restart()},onWimpOut:function(e){window.setTimeout(e,50)},onFlagsChanged:function(e,f){if(e){this.onPrint("This story does not support saving transcripts manually.\n\n")}this._isFixedWidth=f},onSetStyle:function(h,g,f){switch(h){case -1:break;case 0:this._currStyles=["z-roman"];this._reverseVideo=false;break;case 1:this._reverseVideo=true;break;case 2:this._currStyles.push("z-bold");break;case 4:this._currStyles.push("z-italic");break;case 8:this._currStyles.push("z-fixed-pitch");break;default:throw new FatalError("Unknown style: "+h)}var e={0:null,1:"default",2:"black",3:"red",4:"green",5:"yellow",6:"blue",7:"magenta",8:"cyan",9:"white"};if(e[g]){this._foreground=e[g]}if(e[f]){this._background=e[f]}},onSetWindow:function(f){var e=this;if(f==1){if(!e._console){e.onSplitWindow(1)}e._console.moveTo(0,0)}e._activeWindow=f},onEraseWindow:function(f){var e=this;document.body.className="bg-"+e._background;if(f==-2){e._console.clear();e._eraseBottomWindow()}else{if(f==-1){e.onSplitWindow(0);e._eraseBottomWindow()}else{if(f==0){e._eraseBottomWindow()}else{if(f==1&&e._console){e._console.clear()}}}}},onSetCursor:function(e,g){var f=this;if(f._console){f._console.moveTo(e-1,g-1)}},onSetBufferMode:function(e){this._bufferMode=e},onSplitWindow:function(g){var e=this;if(g==0){if(e._console){e._console.close();e._console=null}}else{if(!e._console||e._version==3||!e._bufferMode){e._console=new Console(e._size[0],g,c("#top-window").get(0),e)}else{if(e._console.height!=g){var f=document.createElement("div");f.className="buffered-window";f.innerHTML=e._console.renderHtml();c(f).css({width:e._pixelWidth+"px",lineHeight:e._pixelLineHeight+"px"});c("#buffered-windows").append(f);e._windowResize();e._console.resize(g)}}}e._bufferMode=0},_calcFinalStyles:function(){var g=this,f=g._foreground,h=g._background;if(g._reverseVideo){f=g._background;h=g._foreground;if(f=="default"){f="default-reversed"}if(h=="default"){h="default-reversed"}}var e=["fg-"+f,"bg-"+h];if(g._isFixedWidth){e.push("z-fixed-pitch")}return e.concat(g._currStyles).join(" ")},onPrint:function(g){var f=this,k=f._calcFinalStyles();f._log("print wind: "+f._activeWindow+" output: "+g.quote()+" style: "+k);c(document).trigger({type:"TextOutput",output:{window:f._activeWindow,text:g,styles:k}});if(f._activeWindow==0){var e=g.split("\n");for(var j=0;j<e.length;j++){var h=e[j].entityify();h=h.replace(a,"$1<&>$2");h=h.replace(b,"&nbsp;");h=h.replace(d," ");h='<span class="'+k+'">'+h+"</span>";c("#content").append(h);if(j<e.length-1){c("#content").append("<br/>")}}}else{f._console.write(g,k)}},onPrintTable:function(e){for(var f=0;f<e.length;f++){this.onPrint(e[f])}},_setFixedPitchSizes:function(){var f=this,j=document.createElement("div");j.className="buffered-window";for(var h=0;h<f._size[0];h++){j.innerHTML+="O"}j.innerHTML="<span>"+j.innerHTML+"</span>";c("#buffered-windows").append(j);f._pixelWidth=c(j).width();if(jQuery.browser.msie&&(jQuery.browser.version.length==1||jQuery.browser.version.charAt(1)==".")&&jQuery.browser.version<"7"){var g=-1,e=document.getElementById("top-window").currentStyle.fontSize.toLowerCase();if(e.substring(e.length-2)=="px"){g=0.6*parseInt(e)}else{if(e.substring(e.length-2)=="pt"){g=0.8*parseInt(e)}}if(g>0){f._pixelWidth=f._size[0]*g}}f._pixelLineHeight=c(j.firstChild).height();c("#buffered-windows").empty()}})})(jQuery);window.Quetzal=IFF.subClass({init:function(b){this._super(b);if(b){if(this.type!="IFZS"){throw new Error("Not a Quetzal savefile")}for(var c=0,a=this.chunks.length;c<a;c++){var d=this.chunks[c].type,e=this.chunks[c].data;if(d=="CMem"||d=="UMem"){this.memory=e;this.compressed=(d=="CMem")}else{if(d=="Stks"){this.stacks=e}else{if(d=="IFhd"){this.release=e.slice(0,2);this.serial=e.slice(2,8);this.checksum=e.slice(8,10);this.pc=e[10]<<16|e[11]<<8|e[12]}}}}}},write:function(){this.type="IFZS";var b=this.pc,a=this.release.concat(this.serial,this.checksum,(b>>16)&255,(b>>8)&255,b&255);this.chunks=[{type:"IFhd",data:a},{type:(this.compressed?"CMem":"UMem"),data:this.memory},{type:"Stks",data:this.stacks}];return this._super()}});function EngineRunner(d,c,e){this._engine=d;this._zui=c;this._isRunning=false;this._isInLoop=false;this._isWaitingForCallback=false;this._log=e;var b=this;var a={stop:function(){b._isRunning=false;b._zui._removeBufferedWindows()},run:function(){var f=b._zui.getSize();b._zui.setVersion(b._engine.m_version);b._isRunning=true;b._engine.m_memory[32]=f[1];b._engine.m_memory[33]=f[0];this._engine.setWord(f[0],34);this._engine.setWord(f[1],36);b._continueRunning()},_continueRunning:function(){while(b._isRunning&&!b._isWaitingForCallback){b._loop()}},_receiveLineInput:function(f){b._isWaitingForCallback=false;b._engine.answer(0,13);b._engine.answer(1,f);b._zui._removeBufferedWindows();if(!b._isInLoop){b._continueRunning()}else{}},_receiveCharacterInput:function(f){b._isWaitingForCallback=false;b._engine.answer(0,f);b._zui._removeBufferedWindows();if(!b._isInLoop){b._continueRunning()}else{}},_unWimpOut:function(){b._isWaitingForCallback=false;if(!b._isInLoop){b._continueRunning()}else{}},_loop:function(){if(b._isInLoop){throw new FatalError("Already in loop!")}b._isInLoop=true;var k=b._engine;k.run();var n=k.consoleText();if(n){b._zui.onPrint(n)}var p='"'+k.effect(0)+'"';var g="[ "+k.effect(0);for(var h=1;k.effect(h)!=undefined;h++){var m=k.effect(h);if(typeof m=="string"){m=m.quote()}g+=", "+m}b._log(g+" ]");switch(p){case GNUSTO_EFFECT_INPUT:b._isWaitingForCallback=true;b._zui.onLineInput(b._receiveLineInput);break;case GNUSTO_EFFECT_INPUT_CHAR:b._isWaitingForCallback=true;b._zui.onCharacterInput(b._receiveCharacterInput);break;case GNUSTO_EFFECT_SAVE:k.saveGame();if(b._zui.onSave(k.saveGameData())){k.answer(0,1)}else{k.answer(0,0)}break;case GNUSTO_EFFECT_RESTORE:var q=b._zui.onRestore();if(q){k.loadSavedGame(q)}else{k.answer(0,0)}break;case GNUSTO_EFFECT_QUIT:b.stop();b._zui.onQuit();break;case GNUSTO_EFFECT_RESTART:b.stop();b._zui.onRestart();break;case GNUSTO_EFFECT_WIMP_OUT:b._isWaitingForCallback=true;b._zui.onWimpOut(b._unWimpOut);break;case GNUSTO_EFFECT_BREAKPOINT:throw new FatalError("Unimplemented effect: "+p);case GNUSTO_EFFECT_FLAGS_CHANGED:var j=k.m_printing_header_bits&1;var l=k.m_printing_header_bits&2;b._zui.onFlagsChanged(j,l);break;case GNUSTO_EFFECT_PIRACY:break;case GNUSTO_EFFECT_STYLE:b._zui.onSetStyle(k.effect(1),k.effect(2),k.effect(3));break;case GNUSTO_EFFECT_SOUND:break;case GNUSTO_EFFECT_SPLITWINDOW:b._zui.onSplitWindow(k.effect(1));break;case GNUSTO_EFFECT_SETWINDOW:b._zui.onSetWindow(k.effect(1));break;case GNUSTO_EFFECT_ERASEWINDOW:b._zui.onEraseWindow(k.effect(1));break;case GNUSTO_EFFECT_ERASELINE:throw new FatalError("Unimplemented effect: "+p);case GNUSTO_EFFECT_SETCURSOR:b._zui.onSetCursor(k.effect(2),k.effect(1));break;case GNUSTO_EFFECT_SETBUFFERMODE:b._zui.onSetBufferMode(k.effect(1));break;case GNUSTO_EFFECT_SETINPUTSTREAM:case GNUSTO_EFFECT_GETCURSOR:throw new FatalError("Unimplemented effect: "+p);break;case GNUSTO_EFFECT_PRINTTABLE:var f=k.effect(1);var o=[];for(h=0;h<f;h++){o.push(k.effect(2+h))}b._zui.onPrintTable(o);break}b._isInLoop=false}};for(name in a){b[name]=a[name]}}function Console(d,a,c,b){this.width=d;this.height=a;this._element=c;this._pos=[0,0];this._observer=b;this._isRenderScheduled=false;this.clear()}Console.prototype={resize:function(a){var b=a-this.height;if(b==0){return}var c;if(b>0){for(c=0;c<b;c++){this._addRow()}}else{for(c=0;c<-b;c++){this._delRow()}}this.height=a;this._scheduleRender()},_delRow:function(){this._characters.pop();this._styles.pop()},_addRow:function(){var b=[];var c=[];for(var a=0;a<this.width;a++){b.push("&nbsp;");c.push(null)}this._characters.push(b);this._styles.push(c)},clear:function(){this._characters=[];this._styles=[];for(var a=0;a<this.height;a++){this._addRow()}this._scheduleRender()},moveTo:function(a,b){this._pos=[a,b]},write:function(b,d){var a=this._pos[0];var f=this._pos[1];for(var c=0;c<b.length;c++){var e=null;if(b.charAt(c)==" "){e="&nbsp;"}else{if(b.charAt(c)=="\n"){a=0;f+=1}else{e=b.charAt(c).entityify()}}if(f>this.height-1){this.resize(f+1)}if(e!=null){this._characters[f][a]=e;this._styles[f][a]=d;a+=1}}this._pos=[a,f];this._scheduleRender()},_scheduleRender:function(){if(!this._isRenderScheduled){this._isRenderScheduled=true;var a=this;window.setTimeout(function(){a._doRender()},0)}},renderHtml:function(){var c="";for(var d=0;d<this.height;d++){var b=null;for(var a=0;a<this.width;a++){if(this._styles[d][a]!==b){if(b!==null){c+="</span>"}b=this._styles[d][a];if(b!==null){c+='<span class="'+b+'">'}}c+=this._characters[d][a]}if(b!==null){c+="</span>"}c+="<br/>"}return c},_doRender:function(){this._element.innerHTML=this.renderHtml();this._isRenderScheduled=false;this._observer.onConsoleRender()},close:function(){this._element.innerHTML="";this._observer.onConsoleRender()}};