/*

Parchment
=========

Built: 2011-05-15

Copyright (c) 2008-2011 The Parchment Contributors
BSD licenced
http://code.google.com/p/parchment

*/
jQuery.ajaxSetup({cache:1,converters:{"* binary":true}});jQuery.ajaxPrefilter("script",function(a){if(a.isLocal){a.crossDomain=1}});var parchment={options:{container:"#parchment",lib_path:"lib/",page_title:1,panels:["search","url","about"],proxy_url:"http://zcode.appspot.com/proxy/",width:80},lib:{}};(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(g){var f=this.prototype;a=true;var e=new this();a=false;for(var d in g){e[d]=typeof g[d]=="function"&&typeof f[d]=="function"&&b.test(g[d])?(function(h,i){return function(){var k=this._super;this._super=f[h];var j=i.apply(this,arguments);this._super=k;return j}})(d,g[d]):g[d]}function c(){if(!a&&this.init){this.init.apply(this,arguments)}}c.prototype=e;c.constructor=c;c.subClass=arguments.callee;return c}})();(function(){function b(h,i){return h[i]<<24|h[i+1]<<16|h[i+2]<<8|h[i+3]}function c(h){return[(h>>24)&255,(h>>16)&255,(h>>8)&255,h&255]}function e(h,i){return String.fromCharCode(h[i],h[i+1],h[i+2],h[i+3])}function g(h){return[h.charCodeAt(0),h.charCodeAt(1),h.charCodeAt(2),h.charCodeAt(3)]}var f=Object.subClass({init:function a(k){this.type="";this.chunks=[];if(k){if(e(k,0)!="FORM"){throw new Error("Not an IFF file")}this.type=e(k,8);var j=12,h=k.length;while(j<h){var m=b(k,j+4);if(m<0||(m+j)>h){throw new Error("IFF: Chunk out of range")}this.chunks.push({type:e(k,j),offset:j,data:k.slice(j+8,j+8+m)});j+=8+m;if(m%2){j++}}}},write:function d(){var m=g(this.type);for(var n=0,j=this.chunks.length;n<j;n++){var k=this.chunks[n],o=k.data,h=o.length;m=m.concat(g(k.type),c(h),o);if(h%2){m.push(0)}}return g("FORM").concat(c(m.length),m)}});f.num_from=b;f.num_to_word=c;f.text_from=e;f.text_to_word=g;window.IFF=f})();
/*
 * Taken from "Remedial Javascript" by Douglas Crockford:
 * http://javascript.crockford.com/remedial.html
 */
function typeOf(b){var a=typeof b;if(a==="object"){if(b){if(typeof b.length==="number"&&!(b.propertyIsEnumerable("length"))&&typeof b.splice==="function"){a="array"}}else{a="null"}}return a}function isEmpty(c){var b,a;if(typeOf(c)==="object"){for(b in c){a=c[b];if(a!==undefined&&typeOf(a)!=="function"){return false}}}return true}String.prototype.entityify=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};String.prototype.quote=function(){var e,b,a=this.length,d='"';for(b=0;b<a;b+=1){e=this.charAt(b);if(e>=" "){if(e==="\\"||e==='"'){d+="\\"}d+=e}else{switch(e){case"\b":d+="\\b";break;case"\f":d+="\\f";break;case"\n":d+="\\n";break;case"\r":d+="\\r";break;case"\t":d+="\\t";break;default:e=e.charCodeAt();d+="\\u00"+Math.floor(e/16).toString(16)+(e%16).toString(16)}}}return d+'"'};String.prototype.supplant=function(a){return this.replace(/{([^{}]*)}/g,function(d,c){var e=a[c];return typeof e==="string"||typeof e==="number"?e:d})};String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};(function(a){window.FatalError=function(b){this.message=b;this.traceback=this._makeTraceback(arguments.callee);this.onError(this);if(a(".load").length>0){a(".load").detach()}};FatalError.prototype={onError:function(c){var b=c.message;if(typeof c.message=="string"){b=b.entityify()}a("#parchment").append('<div class="error">An error occurred:<br/><pre>'+b+"\n\n"+c.traceback+"</pre></div>");if(window.console){console.error(b)}},_makeTraceback:function(b){var f="";var d=0;var c=100;while(b!=null&&d<c){var g=b.toString();if(!g){f="\n  (anonymous function)"+f}else{var h=g.match(/function (\w*)/);if(!h||!h[1]){f="\n  (anonymous function)"+f}else{f="\n  "+h[1]+f}}try{b=b.caller}catch(i){b=null}d++}if(d==c){f="..."+f}return"Traceback (most recent call last):\n"+f}}})(jQuery);(function(g,e){if(g.execScript){execScript("Function VBCStr(x)\nVBCStr=CStr(x)\nEnd Function\nFunction VBLastAsc(x)\nDim l\nl=LenB(x)\nIf l mod 2 Then\nVBLastAsc=AscB(MidB(x,l,1))\nElse\nVBLastAsc=-1\nEnd If\nEnd Function","VBScript")}var f=/chrome\/(\d+)/i.exec(navigator.userAgent),d=f&&parseInt(f[1])>4,a=function(q,r){var r=r||[],p=0,o;for(o=q.length%8;p<o;++p){r.push(q.charCodeAt(p)&255)}for(o=q.length;p<o;){r.push(q.charCodeAt(p++)&255,q.charCodeAt(p++)&255,q.charCodeAt(p++)&255,q.charCodeAt(p++)&255,q.charCodeAt(p++)&255,q.charCodeAt(p++)&255,q.charCodeAt(p++)&255,q.charCodeAt(p++)&255)}return r},l=function(p,o){return(o||"")+String.fromCharCode.apply(1,p)},h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c=(function(){var o=[],p=0;for(;p<h.length;p++){o[h.charAt(p)]=p}return o})(),b=function(t,r){if(g.atob){return a(atob(t),r)}var r=r||[],u,q,p,y,x,w,v,s=0,o=t.length;while(s<o){y=c[t.charAt(s++)];x=c[t.charAt(s++)];w=c[t.charAt(s++)];v=c[t.charAt(s++)];u=(y<<2)+(x>>4);q=((x&15)<<4)+(w>>2);p=((w&3)<<6)+v;r.push(u,q,p)}if(v==64){r.pop()}if(w==64){r.pop()}return r},i=function(t,r){if(g.btoa){return btoa(l(t,r))}var r=r||"",u,q,p,y,x,w,v,s=0,o=t.length;while(s<o){u=t[s++];q=t[s++];p=t[s++];y=u>>2;x=((u&3)<<4)+(q>>4);w=((q&15)<<2)+(p>>6);v=p&63;r+=(h.charAt(y)+h.charAt(x)+h.charAt(w)+h.charAt(v))}if(isNaN(q)){r=r.slice(0,-2)+"=="}else{if(isNaN(p)){r=r.slice(0,-1)+"="}}return r},j=function(t){var u=VBCStr(t),s=VBLastAsc(t),o=[],q=0,p=u.length%4,r;while(q<p){o.push((r=u.charCodeAt(q++))&255,r>>8)}p=u.length;while(q<p){o.push((r=u.charCodeAt(q++))&255,r>>8,(r=u.charCodeAt(q++))&255,r>>8,(r=u.charCodeAt(q++))&255,r>>8,(r=u.charCodeAt(q++))&255,r>>8)}if(s>-1){o.push(s)}return o},m=jQuery.ajaxSettings.xhr(),k={binary:m.overrideMimeType&&!(e.browser.opera&&parseFloat(e.browser.version)<10.5)?"charset":"responseBody" in m?"responseBody":0},n=function(q,t,p){var s,o,r;q=e.trim(q);if(p.mode=="base64"){if(g.atob){r=atob(q);s=a(r)}else{s=b(q)}}else{if(p.mode=="charset"){s=a(q)}else{s=j(p.xhr.responseBody)}}p.responseArray=s;p.responseText=r};m=undefined;e.ajaxPrefilter("binary",function(p,s,q){var r=p.isLocal&&!p.crossDomain&&d?0:k.binary,o=p.xhr;p.xhr=function(){return q.xhr=o.apply(p)};p.binary=r;q.done(n);p.jsonp=false;p.jsonpCallback="processBase64Zcode";q.mode="base64";if(p.url.slice(-3).toLowerCase()==".js"){return"jsonp"}if(r&&!p.crossDomain){return"text"}if(p.legacy){p.url=p.legacy;return"jsonp"}p.data="url="+p.url;p.url=parchment.options.proxy_url;if(r&&e.support.cors){return"text"}p.data+="&encode=base64&callback=pproxy";p.jsonpCallback="pproxy";return"jsonp"});e.ajaxPrefilter("text",function(o,q,p){p.mode=o.binary;if(p.mode=="charset"){o.mimeType="text/plain; charset=x-user-defined"}});g.file={text_to_array:a,array_to_text:l,base64_decode:b,base64_encode:i,support:k}})(window,jQuery);(function(b){var d=this,a=b(d),j=b(document),c,g=/iPhone|iPod|iPad|Android/i,k=/\S/,e=d.scrollByPages||function(m){var l=j[0].documentElement.clientHeight,n=l-Math.min(l/10,parseInt(c.css("line-height"))*2);scrollBy(0,n*m)},i=d.getSelection||(document.selection&&function(){return document.selection.createRange().text})||function(){return""},f='<p><a href="'+location.href+"?story=http://mirror.ifarchive.org/",h=function(l){return f+l.path+'">'+l.desc.entityify()+"</a></p>"};b(function(){c=b("body")});d.gIsIphone=g.test(navigator.userAgent);if(b.browser.msie&&parseInt(b.browser.version)<7){b(function(){var m=b("#top-window"),l=function(){m.style.top=document.documentElement.scrollTop+"px"};m.css("position","absolute").resize(l).scroll(l)})}parchment.lib.UI=Object.subClass({init:function(l){this.library=l;this.panels={};this.load_indicator=b('<div class="dialog load"><p>Parchment is loading.<p>&gt; <blink>_</blink></div>')},stylesheet_add:function(){var l=arguments,m;for(m=1;m<l.length;m++){if(document.createStyleSheet){document.createStyleSheet(l[m])}else{b("<link>",{rel:"alternate stylesheet",href:l[m],title:l[0],type:"text/css"}).appendTo("head")[0].disabled=true}}},stylesheet_switch:function(m,l){b('link[rel*="stylesheet"][title="'+m+'"]').each(function(){this.disabled=!l})},load_panels:function(){var l=parchment.options.panels,p,o,n,m=function(){var r=RegExp(o.val().replace(" ","( )?"),"i"),q=b.grep(p,function(s){return r.test(s.path+s.desc)});q=q.slice(0,30);n.html(b.map(q,h).join(""))};if(b.inArray("search",l)!=-1){this.panels.search=b('<div class="panel search"><label for="panel_search">Search the IF Archive for games you can play with Parchment. You might also like to search the <a href="http://ifdb.tads.org">IFDB</a> or the <a href="http://ifwiki.org">IF Wiki</a>.</label><input id="panel_search"><div></div></div>');o=this.panels.search.find("input");n=o.next();o.keydown(function(){o.unbind("keydown");b.getJSON("stories/if-archive.json").done(function(q){p=q;o.keyup(m);m()})})}if(b.inArray("url",l)!=-1){this.panels.url=b('<form class="panel url"><label for="panel_url">You may use Parchment to play any story file on the internet, simply copy its address here:</label><input id="panel_url" name="story"></form>')}this.library.container.append(this.panels[l[0]]);this.panels.active=l[0]}});parchment.lib.TextInput=Object.subClass({init:function(l,q,n){var m=this,p=b("<input>",{autocapitalize:"off",keydown:function(s){var t=s.which,r;if(t==38){m.prev_next(1);r=1}if(t==40){m.prev_next(-1);r=1}if(t==33){e(-1);r=1}if(t==34){e(1);r=1}s.stopPropagation();if(r){return false}}}),o=b("<input>",{"class":"CharInput",keydown:function(r){m.keyCode=r.which},keypress:function(r){m.charCode=r.which;m.submitChar();return false},keyup:function(r){m.submitChar()}});m.form=b("<form>",{"class":"LineInput",submit:function(){m.submitLine();return false}}).append(p);j.bind("click.TextInput keydown.TextInput",function(r){if(r.target.nodeName!="INPUT"&&i()==""&&a.scrollTop()+a.height()-p.offset().top>-60){b(".LineInput input, .CharInput").focus().trigger(r)}});m.history=[];m.lineInput=p;m.charInput=o;m.container=b(l);m.stream=b(q);m.topwindow=b(n);m.scrollParent=b.browser.webkit?c:b("html")},die:function(){j.unbind(".TextInput")},getLine:function(r,o){var n=this,l=n.stream.children().last(),m=n.lineInput,p=b(".finished-input").last(),q=n.scrollParent;n.callback=r||b.noop;n.current=0;n.mutable_history=n.history.slice();n.mutable_history.unshift("");n.style=o||"";m.width(n.stream.width()-l.width()-1).val("").addClass(n.style);l.append(n.form);if(p.length){q.scrollTop(p.offset().top-this.topwindow.height()-p.height())}},submitLine:function(){var l=this,m=l.lineInput.val();l.form.detach();l.lineInput.removeClass(l.style);b('<span class="finished-input">'+m.entityify()+"</span><br>").appendTo(l.stream.children().last());if(m!=l.history[0]&&k.test(m)){l.history.unshift(m)}j.trigger({type:"LineInput",input:m});l.callback(m)},prev_next:function(q){var m=this,l=m.lineInput,n=m.mutable_history,o=m.current,p=o+q;if(p<n.length&&p>=0){n[o]=l.val();l.val(n[p]);m.current=p}},getChar:function(n){var m=this,l=m.charInput;m.callback=n||b.noop;m.keyCode=m.charCode=0;m.container.append(l);setTimeout(function(){l.focus()},1)},submitChar:function(){var n=this,o=n.keyCode,l=n.charCode,m={keyCode:o,charCode:l};if(!o&&!l){return}n.charInput.detach();j.trigger({type:"CharInput",input:m});n.callback(m)}})})(jQuery);(function(g,d){var a=/story=([^;&]+)/,h=/vm=(\w+)/,i=/([-\w\s_]+)(\.[\w]+(\.js)?)?$/,k=/\.js$/,e=function(){throw new FatalError("Parchment could not load load the story. Check your connection, and that the URL is correct.")};parchment.lib.Story=IFF.subClass({init:function j(r,n){this.title=n;if(r[0]<9){this._super();this.chunks.push({type:"ZCOD",data:r});this.zcode=r}else{if(IFF.text_from(r,0)=="Glul"){this._super();this.chunks.push({type:"GLUL",data:r});this.glulx=r}else{if(IFF.text_from(r,0)=="FORM"){this._super(r);if(this.type=="IFRS"){for(var p=0,m=this.chunks.length;p<m;p++){var q=this.chunks[p].type;if(q=="ZCOD"&&!this.zcode){this.zcode=this.chunks[p].data}else{if(q=="GLUL"&&!this.glulx){this.glulx=this.chunks[p].data}else{if(q=="IFmd"){this.metadata=file.array_to_text(this.chunks[p].data);var o=d(this.metadata);if(o){if(d("title",o)){this.title=d("title",o).text()}if(d("ifid",o)){this.ifid=d("ifid",o).text()}if(d("release",o)){this.release=d("release",o).text()}}}}}}}}}}},load:function f(l){if(this.zcode){l.loadStory(this.zcode)}}});var b=Object.subClass({add:function(l){this[l.ifid]=l;if(l.url){this.url[l.url]=l}},url:{}}),c=Object.subClass({init:function(){this.container=d(parchment.options.container);this.ui=new parchment.lib.UI(this)},load:function(s){var l=this,n=parchment.options,q=a.exec(location.search),m,p=h.exec(location.search),o=0;if(n.lock_story){q=n.default_story}else{if(n.default_story||q){q=q&&unescape(q[1])||n.default_story}else{return this.ui.load_panels()}}d("#about").remove();d("body").append(l.ui.load_indicator);if(!d.isArray(q)){q=[q,0]}m=q[0];l.url=m;storyName=i.exec(m);storyName=storyName?storyName[1]+" - Parchment":"Parchment";if(n.page_title){g.document.title=storyName}if(p){p=parchment.vms[p[1]]}else{for(;o<parchment.vms.length;o++){if(parchment.vms[o].match.test(m)){p=parchment.vms[o];break}}}if(!p){throw new FatalError("File type is not supported!")}try{this.launch(p,q)}catch(r){throw new FatalError(r)}},launch:function(p,q){var m=this,r=[d.ajax(q[0],{dataType:"binary",legacy:q[1]}).done(function(t,u,s){s.library=m}).fail(e)],l=[],o=0,n;if(!p.loaded){p.loaded=1;while(o<p.files.length){n=parchment.options.lib_path+p.files[o++];if(k.test(n)){l.push(d.getScript(n))}else{this.ui.stylesheet_add(p.id,n)}}r[1]=d.when.apply(1,l)}d.when.apply(1,r).done(p.launcher)},stories:new b(),savefiles:{}});parchment.lib.Library=c;parchment.vms=[]})(window,jQuery);parchment.vms.quixe={id:"quixe",match:/(ulx|glb|(g|glulx.+)(blorb|blb))(.js)?$/i,files:["prototype.min.js","glkote.min.js","quixe.min.js","../src/quixe/media/i7-glkote.css","../src/quixe/media/dialog.css"],launcher:function(b){var d=b[2],a=d.library,c=new parchment.lib.Story(d.responseArray,storyName),e={inspacing:0,outspacing:0,vm:Quixe,};a.ui.stylesheet_switch("quixe",1);jQuery("#parchment").html('<div id="gameport"><div id="windowport"></div><div id="errorpane" style="display:none;"><div id="errorcontent">...</div></div><div id="layouttestpane">This should not be visible<div id="layouttest_grid" class="WindowFrame GridWindow"><div id="layouttest_gridline" class="GridLine"><span id="layouttest_gridspan" class="Style_normal">12345678</span></div><div id="layouttest_gridline2" class="GridLine"><span class="Style_normal">12345678</span></div></div><div id="layouttest_buffer" class="WindowFrame BufferWindow"><div id="layouttest_bufferline" class="BufferLine"><span id="layouttest_bufferspan" class="Style_normal">12345678</span></div><div id="layouttest_bufferline2" class="BufferLine"><span class="Style_normal">12345678</span></div></div></div></div>');if(jQuery(".load").length>0){jQuery(".load").detach()}Quixe.prepare(c.glulx,e);Glk.init(e)}};parchment.vms.push(parchment.vms.quixe);parchment.vms.gnusto={id:"gnusto",match:/(z[1-8]|zlb|(z|zcode.+)(blorb|blb))(.js)?$/i,files:["gnusto.min.js","zmachine.min.js"],launcher:function(c){var h=window.console&&function(i){console.log(i)}||function(){},g=c[2],d=new GnustoEngine(h),b=new parchment.lib.ZUI(g.library,d,h),f=new EngineRunner(d,b,h),e=new parchment.lib.Story(g.responseArray,storyName),a=location.hash;h("Story type: "+e.filetype);e.load(d);if(a&&a!="#"){d.loadSavedGame(file.base64_decode(a.slice(1)));h("Loading savefile")}f.run()}};parchment.vms.push(parchment.vms.gnusto);(function(a,b){var c=a.parchment;b(function(){var e=/options=([^;&]+)/.exec(location.search),d;if(a.parchment_options){b.extend(c.options,parchment_options)}if(!c.options.lock_options&&e){b.extend(c.options,b.parseJSON(unescape(e[1])))}d=new c.lib.Library();c.library=d;d.load();if(location.href.indexOf("iplayif.com")!=-1){b.getScript("http://google-analytics.com/ga.js",function(){_gat._getTracker("UA-7949545-3")._trackPageview()})}})})(this,jQuery);